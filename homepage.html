<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BenzStock — Home</title>

  <style>
    :root{
      --bg:#0b0f1a; --bg2:#0a0e18; --panel:#111831; --line:#1d2745;
      --text:#f2f6ff; --muted:#96a3c1; --accent:#00e6a8; --down:#ff5252; --up:#1be28b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(900px 600px at 10% -10%,#172555,transparent),linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text)}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--line);background:rgba(0,0,0,.15);backdrop-filter:saturate(1.2) blur(8px);position:sticky;top:0;z-index:10}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#21ffc7,#1a9fff)}
    .title{font-weight:800;letter-spacing:.2px}
    .right{display:flex;align-items:center;gap:10px;position:relative}
    .pfp{width:36px;height:36px;border-radius:50%;background:#273354;border:1px solid var(--line)}
    .dots{border:none;background:transparent;color:var(--text);font-size:22px;cursor:pointer;padding:4px 8px;border-radius:10px}
    .dots:hover{background:rgba(255,255,255,.06)}
    .menu{position:absolute;right:0;top:52px;width:240px;background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden;display:none;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .menu a,.menu button{display:flex;gap:10px;align-items:center;width:100%;padding:12px 14px;background:transparent;border:none;color:var(--text);text-align:left;text-decoration:none;font:inherit;cursor:pointer}
    .menu a:hover,.menu button:hover{background:#0e142a}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .grid{display:grid;grid-template-columns:280px 1fr;gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .side{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
    .side h3{margin:4px 2px 10px;font-size:14px;color:var(--muted)}
    .filter{display:flex;flex-direction:column;gap:10px}
    .filter input,.filter select{padding:10px;border-radius:10px;border:1px solid var(--line);background:#0e142b;color:var(--text)}
    .main{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .toolbar{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line);background:#101735}
    .toolbar h2{margin:0;font-size:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 14px;border-bottom:1px solid var(--line);font-size:14px}
    th{color:var(--muted);font-weight:700;background:#0f1732}
    tr:hover{background:#0f1630}
    .pill{padding:4px 8px;border-radius:999px;background:#0c1a2e;border:1px solid var(--line);color:var(--muted);font-size:12px}
    .chg-up{color:var(--up);font-weight:700}
    .chg-down{color:var(--down);font-weight:700}
    .badge{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden></div>
      <div class="title">BenzStock</div>
    </div>

    <div class="right">
      <div id="userEmail" class="badge"></div>
      <div class="pfp" id="pfp" title="Profile"></div>
      <button class="dots" id="dots" aria-label="menu">⋮</button>
      <div class="menu" id="menu">
        <a href="portfolio.html">My Portfolio &amp; BenzStocks</a>
        <a href="friends.html">My Friends</a>
        <a href="transfer.html">Transfer</a>
        <a href="settings.html">Settings</a>
        <a href="terms.html">Terms of Service</a>
        <a href="conditions.html">Conditions</a>
        <button id="logoutBtn">Log out</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <aside class="side">
        <h3>Filters</h3>
        <div class="filter">
          <input id="q" type="text" placeholder="Search symbol…">
          <select id="cap">
            <option value="">Market Cap (any)</option>
            <option value="S">Small</option>
            <option value="M">Mid</option>
            <option value="L">Large</option>
          </select>
          <button id="clear" class="pill">Clear</button>
        </div>
      </aside>

      <section class="main">
        <div class="toolbar">
          <h2>Market</h2>
          <span class="pill" id="count">0 results</span>
        </div>

        <table id="tbl">
          <thead>
            <tr>
              <th style="width:18%">Symbol</th>
              <th style="width:18%">Price</th>
              <th style="width:18%">Change</th>
              <th style="width:18%">Volume</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </section>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ---------- GitHub Pages base path ----------
    const BASE = location.pathname.includes('/Invest-On-Benzstock/')
      ? '/Invest-On-Benzstock/'
      : '/';
    const go = (p)=> location.href = BASE + p;

    // ---------- Supabase ----------
    const SUPABASE_URL = "https://gsacnctvnpowrpeukkij.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdzYWNuY3R2bnBvd3JwZXVra2lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MDYwMzcsImV4cCI6MjA3MDM4MjAzN30.mEzg4xvlmgpkQC8XYdKRETe70vMRzHhgaERJSLL5wGA";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
    });

    // ---------- Auth guard with session-restore wait ----------
    async function ensureAuth() {
      // 1) immediate check
      let { data:{ session } } = await supabaseClient.auth.getSession();
      if (session) { setUser(session.user); return session; }

      // 2) wait briefly for session restore (GitHub Pages is static)
      const wait = (ms)=> new Promise(res=>setTimeout(res, ms));
      for (let i=0;i<8;i++){ // up to ~1.6s
        await wait(200);
        ({ data:{ session } } = await supabaseClient.auth.getSession());
        if (session){ setUser(session.user); return session; }
      }

      // 3) listen one-shot for SIGNED_IN (rare on reload)
      let done=false;
      const { data: sub } = supabaseClient.auth.onAuthStateChange((evt, sess)=>{
        if (done) return;
        if (evt === 'SIGNED_IN' && sess){ done=true; setUser(sess.user); sub.subscription.unsubscribe(); }
      });
      // timeout after 1s
      await wait(1000);
      if (!done) go('login.html');
    }

    function setUser(user){
      const emailEl=document.getElementById('userEmail');
      emailEl.textContent = user?.email ?? '';
    }

    // ---------- UI menu ----------
    const dots = document.getElementById('dots');
    const menu = document.getElementById('menu');
    dots.addEventListener('click', ()=>{
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    });
    document.addEventListener('click', (e)=>{
      if (!menu.contains(e.target) && e.target !== dots){ menu.style.display='none'; }
    });

    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      await supabaseClient.auth.signOut();
      go('login.html');
    });

    // ---------- Data fetch + filters ----------
    const q = document.getElementById('q');
    const cap = document.getElementById('cap');
    const clearBtn = document.getElementById('clear');
    const rows = document.getElementById('rows');
    const count = document.getElementById('count');

    async function loadStocks(){
      // Pull all (you can switch to paginated selects later)
      const { data, error } = await supabaseClient
        .from('stocks')
        .select('symbol, price, change, volume, notes')
        .order('symbol',{ascending:true});

      if (error) { console.error(error); return; }

      const term = q.value.trim().toUpperCase();
      const capClass = cap.value; // S/M/L if you add that column later

      const filtered = data.filter(r => {
        const matchesTerm = !term || r.symbol.toUpperCase().includes(term);
        const matchesCap = !capClass || r.cap_class === capClass; // safe if column absent
        return matchesTerm && matchesCap;
      });

      rows.innerHTML = '';
      filtered.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.symbol}</td>
          <td>$${Number(r.price ?? 0).toFixed(2)}</td>
          <td class="${(r.change ?? 0) >= 0 ? 'chg-up' : 'chg-down'}">
            ${(r.change ?? 0) >= 0 ? '+' : ''}${Number(r.change ?? 0).toFixed(2)}%
          </td>
          <td>${r.volume ?? 0}</td>
          <td>${r.notes ?? ''}</td>
        `;
        rows.appendChild(tr);
      });
      count.textContent = `${filtered.length} result${filtered.length===1?'':'s'}`;
    }

    q.addEventListener('input', loadStocks);
    cap.addEventListener('change', loadStocks);
    clearBtn.addEventListener('click', ()=>{
      q.value=''; cap.value=''; loadStocks();
    });

    // ---------- Boot ----------
    (async () => {
      await ensureAuth();
      await loadStocks();
    })();
  </script>
</body>
</html>
